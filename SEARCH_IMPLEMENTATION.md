# æœç´¢åŠŸèƒ½å®ç°æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ¬¡é‡æ„ä¸ºCMPP Gatewayæ·»åŠ äº†å®Œæ•´çš„æ¶ˆæ¯å†å²è®°å½•æœç´¢åŠŸèƒ½ï¼Œæ”¯æŒä¸‹å‘è®°å½•å’Œä¸Šè¡Œè®°å½•çš„å¤šæ¡ä»¶æœç´¢ï¼Œå¹¶ä¸ç°æœ‰çš„åˆ†é¡µç³»ç»Ÿå®Œç¾é›†æˆã€‚

## å®ç°èƒŒæ™¯

- **é—®é¢˜**: åŸæœ‰çš„æ¶ˆæ¯å†å²è®°å½•é¡µé¢åªæ”¯æŒæŒ‰æ—¶é—´åˆ†é¡µæµè§ˆï¼Œæ— æ³•æ ¹æ®ç‰¹å®šæ¡ä»¶ç­›é€‰æ¶ˆæ¯
- **éœ€æ±‚**: ç”¨æˆ·éœ€è¦èƒ½å¤ŸæŒ‰ç…§æ¥æ”¶å·ç ã€å‘é€å·ç ã€æ¶ˆæ¯å†…å®¹å’Œå‘é€çŠ¶æ€ç­‰æ¡ä»¶å¿«é€ŸæŸ¥æ‰¾ç‰¹å®šæ¶ˆæ¯
- **æŠ€æœ¯è¦æ±‚**: æœç´¢åŠŸèƒ½éœ€è¦åŒæ—¶æ”¯æŒBoltDBå’ŒRedisä¸¤ç§ç¼“å­˜åç«¯

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¯ æœç´¢æ¡ä»¶

#### ä¸‹å‘è®°å½•æœç´¢ (`/list_message`)
- **æ¥æ”¶å·ç ** (`dest`): æ”¯æŒæ¨¡ç³ŠåŒ¹é…æ‰‹æœºå·ç 
- **å‘é€çŠ¶æ€** (`status`): æ”¯æŒç­›é€‰æˆåŠŸ(0)å’Œå¤±è´¥(1)çš„æ¶ˆæ¯
- **å†…å®¹å…³é”®è¯** (`content`): æ”¯æŒæ¨¡ç³ŠåŒ¹é…çŸ­ä¿¡å†…å®¹

#### ä¸Šè¡Œè®°å½•æœç´¢ (`/list_mo`)
- **å‘é€å·ç ** (`src`): æ”¯æŒæ¨¡ç³ŠåŒ¹é…æ‰‹æœºå·ç 
- **æ¥æ”¶å·ç ** (`dest`): æ”¯æŒæ¨¡ç³ŠåŒ¹é…æœåŠ¡å·ç 
- **å†…å®¹å…³é”®è¯** (`content`): æ”¯æŒæ¨¡ç³ŠåŒ¹é…çŸ­ä¿¡å†…å®¹

### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
- **ä¸åŒºåˆ†å¤§å°å†™æœç´¢**: æ‰€æœ‰æ–‡æœ¬æœç´¢éƒ½è½¬æ¢ä¸ºå°å†™è¿›è¡Œæ¯”è¾ƒ
- **å¤åˆæ¡ä»¶æœç´¢**: æ”¯æŒå¤šä¸ªæœç´¢æ¡ä»¶åŒæ—¶ç”Ÿæ•ˆ
- **URLå‚æ•°ä¿æŒ**: åˆ†é¡µå¯¼èˆªæ—¶ä¿æŒæœç´¢æ¡ä»¶
- **è¡¨å•çŠ¶æ€ä¿æŒ**: æœç´¢è¡¨å•è‡ªåŠ¨å¡«å……å½“å‰æœç´¢æ¡ä»¶
- **æ¸…é™¤æœç´¢**: ä¸€é”®æ¸…é™¤æ‰€æœ‰æœç´¢æ¡ä»¶

## æŠ€æœ¯å®ç°

### 1. ç¼“å­˜æ¥å£æ‰©å±•

#### CacheInterface æ¥å£æ›´æ–°
```go
type CacheInterface interface {
    // åŸæœ‰æ–¹æ³•...
    SetWaitCache(key uint32, message SmsMes) error
    GetWaitCache(key uint32) (SmsMes, error)
    AddSubmits(mes *SmsMes) error
    AddMoList(mes *SmsMes) error
    Length(listName string) int
    GetStats() map[string]int
    GetList(listName string, start, end int) *[]SmsMes

    // æ–°å¢æœç´¢æ–¹æ³•
    SearchList(listName string, filters map[string]string, start, end int) *[]SmsMes
    GetSearchCount(listName string, filters map[string]string) int
}
```

### 2. Redis å®ç°æœç´¢åŠŸèƒ½

#### æ ¸å¿ƒæœç´¢é€»è¾‘
```go
// SearchList åœ¨Redisä¸­æœç´¢æ¶ˆæ¯åˆ—è¡¨
func (c *Cache) SearchList(listName string, filters map[string]string, start, end int) *[]SmsMes {
    // 1. è·å–æ‰€æœ‰æ•°æ®è¿›è¡Œå†…å­˜è¿‡æ»¤ï¼ˆRedisä¸æ”¯æŒå¤æ‚æœç´¢ï¼‰
    // 2. æ ¹æ®è¿‡æ»¤æ¡ä»¶ç­›é€‰æ¶ˆæ¯
    // 3. åº”ç”¨åˆ†é¡µé€»è¾‘
    // 4. è¿”å›ç»“æœ
}
```

#### è¿‡æ»¤æ¡ä»¶å®ç°
```go
func (c *Cache) matchFilters(mes *SmsMes, filters map[string]string, listName string) bool {
    // é€šç”¨è¿‡æ»¤ï¼šå†…å®¹å…³é”®è¯
    if content, ok := filters["content"]; ok && content != "" {
        if !contains(mes.Content, content) {
            return false
        }
    }

    // ä¸‹å‘æ¶ˆæ¯ç‰¹å®šè¿‡æ»¤ï¼šæ¥æ”¶å·ç ã€å‘é€çŠ¶æ€
    // ä¸Šè¡Œæ¶ˆæ¯ç‰¹å®šè¿‡æ»¤ï¼šå‘é€å·ç ã€æ¥æ”¶å·ç 
}
```

### 3. BoltDB å®ç°æœç´¢åŠŸèƒ½

#### æœç´¢å®ç°
```go
// SearchList åœ¨BoltDBä¸­æœç´¢æ¶ˆæ¯åˆ—è¡¨
func (c *BoltCache) SearchList(listName string, filters map[string]string, start, end int) *[]SmsMes {
    // 1. éå†æ•°æ®åº“ä¸­çš„æ‰€æœ‰è®°å½•
    // 2. åº”ç”¨è¿‡æ»¤æ¡ä»¶
    // 3. æ”¶é›†åŒ¹é…çš„æ¶ˆæ¯
    // 4. åº”ç”¨åˆ†é¡µé€»è¾‘
}
```

### 4. HTTP å¤„ç†å™¨æ›´æ–°

#### æœç´¢å‚æ•°å¤„ç†
```go
func listMessage(w http.ResponseWriter, r *http.Request, listName string, activePage string) {
    // è§£ææœç´¢å‚æ•°
    filters := make(map[string]string)
    if listName == "list_message" {
        if dest := r.Form.Get("dest"); dest != "" {
            filters["dest"] = dest
        }
        if status := r.Form.Get("status"); status != "" {
            filters["status"] = status
        }
    } else if listName == "list_mo" {
        if src := r.Form.Get("src"); src != "" {
            filters["src"] = src
        }
        if dest := r.Form.Get("dest"); dest != "" {
            filters["dest"] = dest
        }
    }
    if content := r.Form.Get("content"); content != "" {
        filters["content"] = content
    }

    // æ ¹æ®æ˜¯å¦æœ‰æœç´¢æ¡ä»¶é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼
    var count int
    var v *[]SmsMes
    if len(filters) > 0 {
        count = SCache.GetSearchCount(listName, filters)
        page := pages.NewPage(c_page, pageSize, count)
        v = SCache.SearchList(listName, filters, page.StartRow, page.EndRow)
    } else {
        count = SCache.Length(listName)
        page := pages.NewPage(c_page, pageSize, count)
        v = SCache.GetList(listName, page.StartRow, page.EndRow)
    }
}
```

### 5. å‰ç«¯æ¨¡æ¿æ›´æ–°

#### æœç´¢è¡¨å•å¢å¼º
- **è¡¨å•å­—æ®µ**: æ·»åŠ äº†ç›¸åº”çš„nameå±æ€§ä»¥æ”¯æŒè¡¨å•æäº¤
- **å€¼ä¿æŒ**: ä½¿ç”¨æ¨¡æ¿å˜é‡ä¿æŒå½“å‰æœç´¢å€¼
- **æ¸…é™¤æŒ‰é’®**: æä¾›ä¸€é”®æ¸…é™¤æœç´¢åŠŸèƒ½

#### URLæ„å»ºæ¨¡æ¿å‡½æ•°
```go
"buildPageURL": func(page int, filters map[string]string) string {
    params := make([]string, 0, len(filters)+1)
    params = append(params, fmt.Sprintf("page=%d", page))

    for key, value := range filters {
        if value != "" {
            params = append(params, fmt.Sprintf("%s=%s", key, value))
        }
    }

    return "?" + strings.Join(params, "&")
}
```

#### JavaScript æœç´¢é€»è¾‘
```javascript
// è¡¨å•æäº¤å¤„ç†
document.getElementById('filter-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const params = new URLSearchParams();

    // æ„å»ºæœç´¢å‚æ•°
    for (const [key, value] of formData.entries()) {
        if (value.trim() !== '') {
            params.append(key, value);
        }
    }

    // é‡ç½®åˆ°ç¬¬ä¸€é¡µå¹¶è·³è½¬
    params.set('page', '1');
    window.location.href = '?' + params.toString();
});

// æ¸…é™¤æœç´¢
function clearSearch() {
    window.location.href = '?';
}
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬æœç´¢
```
# æœç´¢æ¥æ”¶å·ç ä¸º13800138000çš„æ‰€æœ‰æ¶ˆæ¯
http://localhost:8000/list_message?dest=13800138000

# æœç´¢åŒ…å«"é‡è¦"å…³é”®è¯çš„æ‰€æœ‰æ¶ˆæ¯
http://localhost:8000/list_message?content=é‡è¦

# æœç´¢å¤±è´¥çš„æ¶ˆæ¯
http://localhost:8000/list_message?status=1
```

### 2. å¤åˆæœç´¢
```
# æœç´¢æ¥æ”¶å·ç ä¸º13800138000ä¸”åŒ…å«"æµ‹è¯•"çš„æ¶ˆæ¯
http://localhost:8000/list_message?dest=13800138000&content=æµ‹è¯•

# æœç´¢å‘é€å·ç ä¸º13900139000ä¸”åŒ…å«"ä½ å¥½"çš„ä¸Šè¡Œæ¶ˆæ¯
http://localhost:8000/list_mo?src=13900139000&content=ä½ å¥½
```

### 3. åˆ†é¡µæœç´¢
```
# æœç´¢ç»“æœçš„ç¬¬äºŒé¡µ
http://localhost:8000/list_message?content=æµ‹è¯•&page=2
```

## æ€§èƒ½è€ƒè™‘

### Redis åç«¯
- **ç­–ç•¥**: è·å–æ‰€æœ‰æ•°æ®åˆ°å†…å­˜è¿›è¡Œè¿‡æ»¤
- **ä¼˜åŒ–**: å¯¹äºå¤§é‡æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘æ·»åŠ ç´¢å¼•æˆ–ä½¿ç”¨Redisçš„æœç´¢æ¨¡å—
- **å½“å‰é™åˆ¶**: é€‚åˆä¸­å°è§„æ¨¡æ•°æ®é›†

### BoltDB åç«¯
- **ç­–ç•¥**: éå†æ•°æ®åº“è¿›è¡Œè¿‡æ»¤
- **ä¼˜åŒ–**: åˆ©ç”¨BoltDBçš„é«˜æ•ˆéå†æ€§èƒ½
- **ä¼˜åŠ¿**: é€‚åˆæœ¬åœ°éƒ¨ç½²ï¼Œæ— éœ€é¢å¤–ä¾èµ–

### é€šç”¨ä¼˜åŒ–
- **åˆ†é¡µé™åˆ¶**: åªåŠ è½½å½“å‰é¡µéœ€è¦çš„æ•°æ®
- **ç¼“å­˜å‹å¥½**: æœç´¢ç»“æœå¯ä»¥ç¼“å­˜ä»¥æé«˜æ€§èƒ½
- **ç´¢å¼•å»ºè®®**: æœªæ¥å¯ä»¥æ·»åŠ ä¸“é—¨çš„æ•°æ®ç»“æ„æ”¯æŒé«˜æ•ˆæœç´¢

## æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•
âœ… æŒ‰æ¥æ”¶å·ç æœç´¢æ­£å¸¸å·¥ä½œ
âœ… æŒ‰å‘é€å·ç æœç´¢æ­£å¸¸å·¥ä½œ
âœ… æŒ‰å†…å®¹å…³é”®è¯æœç´¢æ­£å¸¸å·¥ä½œ
âœ… æŒ‰å‘é€çŠ¶æ€æœç´¢æ­£å¸¸å·¥ä½œ
âœ… å¤åˆæ¡ä»¶æœç´¢æ­£å¸¸å·¥ä½œ
âœ… æœç´¢æ¡ä»¶åœ¨è¡¨å•ä¸­æ­£ç¡®ä¿æŒ
âœ… åˆ†é¡µé“¾æ¥æ­£ç¡®ä¿æŒæœç´¢å‚æ•°
âœ… æ¸…é™¤æœç´¢åŠŸèƒ½æ­£å¸¸

### å…¼å®¹æ€§æµ‹è¯•
âœ… BoltDBåç«¯æœç´¢åŠŸèƒ½æ­£å¸¸
âœ… Redisåç«¯æœç´¢åŠŸèƒ½æ­£å¸¸
âœ… æ— æœç´¢å‚æ•°æ—¶æ­£å¸¸æ˜¾ç¤ºå…¨éƒ¨è®°å½•

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–
- **æ•°æ®ç´¢å¼•**: ä¸ºå¸¸ç”¨æœç´¢å­—æ®µæ·»åŠ ç´¢å¼•
- **æœç´¢ç¼“å­˜**: ç¼“å­˜çƒ­é—¨æœç´¢æ¡ä»¶çš„ç»“æœ
- **å¼‚æ­¥æœç´¢**: å¯¹äºå¤§é‡æ•°æ®ï¼Œè€ƒè™‘å¼‚æ­¥æœç´¢

### 2. åŠŸèƒ½æ‰©å±•
- **æ—¥æœŸèŒƒå›´æœç´¢**: æ”¯æŒæŒ‰æ—¶é—´æ®µç­›é€‰
- **æ­£åˆ™è¡¨è¾¾å¼æœç´¢**: æ”¯æŒæ›´å¤æ‚çš„æ–‡æœ¬åŒ¹é…
- **æœç´¢å†å²**: ä¿å­˜ç”¨æˆ·çš„æœç´¢å†å²

### 3. ç”¨æˆ·ä½“éªŒ
- **æœç´¢å»ºè®®**: æä¾›æœç´¢å…³é”®è¯è‡ªåŠ¨å®Œæˆ
- **æœç´¢é«˜äº®**: åœ¨ç»“æœä¸­é«˜äº®åŒ¹é…çš„å…³é”®è¯
- **æœç´¢ç»Ÿè®¡**: æ˜¾ç¤ºæœç´¢ç»“æœæ•°é‡å’Œè€—æ—¶

## éƒ¨ç½²è¯´æ˜

### é…ç½®æ›´æ–°
æ— éœ€é¢å¤–é…ç½®ï¼Œæœç´¢åŠŸèƒ½ä¼šè‡ªåŠ¨é€‚é…ç°æœ‰çš„ç¼“å­˜åç«¯é…ç½®ã€‚

### è·¯ç”±æ›´æ–°
æ–°å¢äº†`/submit`è·¯ç”±ä»¥ä¿æŒAPIä¸€è‡´æ€§ï¼š
```go
http.HandleFunc("/submit", handler)  // ä¸»è¦APIç«¯ç‚¹
http.HandleFunc("/send", handler)   // å‘åå…¼å®¹
```

### æ•°æ®åº“è¿ç§»
ç°æœ‰æ•°æ®å®Œå…¨å…¼å®¹ï¼Œæ— éœ€æ•°æ®è¿ç§»ã€‚

## æ€»ç»“

æœ¬æ¬¡æœç´¢åŠŸèƒ½å®ç°ä¸ºCMPP Gatewayå¢åŠ äº†å¼ºå¤§çš„æ¶ˆæ¯æ£€ç´¢èƒ½åŠ›ï¼Œåœ¨ä¿æŒç³»ç»Ÿæ€§èƒ½çš„åŒæ—¶æä¾›äº†çµæ´»çš„æœç´¢é€‰é¡¹ã€‚é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æ¥å£å’Œå®ç°ï¼Œæœç´¢åŠŸèƒ½èƒ½å¤Ÿæ— ç¼é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿä¸­ï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„ä½¿ç”¨ä½“éªŒã€‚

### ä¸»è¦æˆå°±
- ğŸ¯ **å®Œæ•´æœç´¢åŠŸèƒ½**: æ”¯æŒå¤šæ¡ä»¶å¤åˆæœç´¢
- ğŸ”„ **æ— ç¼é›†æˆ**: ä¸ç°æœ‰åˆ†é¡µç³»ç»Ÿå®Œç¾ç»“åˆ
- ğŸ’¾ **åŒåç«¯æ”¯æŒ**: åŒæ—¶æ”¯æŒBoltDBå’ŒRedis
- ğŸ“± **ç”¨æˆ·å‹å¥½**: ç›´è§‚çš„æœç´¢ç•Œé¢å’Œäº¤äº’
- ğŸš€ **é«˜æ€§èƒ½**: ä¼˜åŒ–çš„æœç´¢ç®—æ³•å’Œæ•°æ®è®¿é—®

è¿™æ¬¡é‡æ„ä¸ºCMPP Gatewayçš„æœç´¢åŠŸèƒ½å¥ å®šäº†åšå®çš„åŸºç¡€ï¼Œä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•æä¾›äº†è‰¯å¥½çš„æ¶æ„æ”¯æŒã€‚