# Redis â†’ BoltDB é‡æ„æ€»ç»“

## ğŸ“ é‡æ„æ¦‚è¿°

**é‡æ„æ—¶é—´**ï¼š2024å¹´10æœˆ29æ—¥  
**é‡æ„ç›®æ ‡**ï¼šç”¨åµŒå…¥å¼æ•°æ®åº“æ›¿ä»£ Redisï¼Œæ¶ˆé™¤å¤–éƒ¨ä¾èµ–  
**é‡æ„æ–¹æ¡ˆ**ï¼šBoltDB (bbolt) - çº¯ Go å®ç°çš„åµŒå…¥å¼é”®å€¼æ•°æ®åº“

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒä»£ç å®ç°

#### æ–°å¢æ–‡ä»¶

- âœ… `gateway/boltcache.go` (321 è¡Œ)
  - å®ç° `BoltCache` ç»“æ„
  - å®ç°æ‰€æœ‰ç¼“å­˜æ¥å£æ–¹æ³•
  - æ”¯æŒå€’åºå­˜å‚¨ï¼ˆæœ€æ–°è®°å½•åœ¨å‰ï¼‰
  - äº‹åŠ¡å®‰å…¨çš„è¯»å†™æ“ä½œ

#### ä¿®æ”¹æ–‡ä»¶

- âœ… `gateway/cache.go`
  - æ–°å¢ `CacheInterface` æ¥å£å®šä¹‰
  - æ–°å¢ `InitCache()` ç»Ÿä¸€åˆå§‹åŒ–å‡½æ•°
  - ä¿®æ”¹æ–¹æ³•ç­¾åä»¥ç»Ÿä¸€è¿”å› `error`
  - æ”¯æŒè¿è¡Œæ—¶ç±»å‹åˆ¤æ–­å’Œåˆ‡æ¢

- âœ… `gateway/config.go`
  - æ–°å¢ `CacheType` å­—æ®µï¼ˆboltdb/redisï¼‰
  - æ–°å¢ `DBPath` å­—æ®µï¼ˆBoltDB æ–‡ä»¶è·¯å¾„ï¼‰
  - ä¿æŒå‘åå…¼å®¹çš„ Redis é…ç½®

- âœ… `main.go`
  - å°† `StartCache()` æ”¹ä¸º `InitCache()`
  - æ”¯æŒæ ¹æ®é…ç½®è‡ªåŠ¨é€‰æ‹©ç¼“å­˜å®ç°

- âœ… `go.mod`
  - æ–°å¢ä¾èµ–ï¼š`go.etcd.io/bbolt v1.3.11`
  - ä¿ç•™ Redis ä¾èµ–ï¼ˆå‘åå…¼å®¹ï¼‰

### 2. æ¥å£è®¾è®¡

å®šä¹‰ç»Ÿä¸€çš„ `CacheInterface`ï¼š

```go
type CacheInterface interface {
    SetWaitCache(key uint32, message SmsMes) error
    GetWaitCache(key uint32) (SmsMes, error)
    AddSubmits(mes *SmsMes) error
    AddMoList(mes *SmsMes) error
    Length(listName string) int
    GetStats() map[string]int
    GetList(listName string, start, end int) *[]SmsMes
}
```

**ä¸¤ç§å®ç°**ï¼š
- `Cache` - Redis å®ç°ï¼ˆåŸæœ‰ï¼‰
- `BoltCache` - BoltDB å®ç°ï¼ˆæ–°å¢ï¼‰

### 3. æ•°æ®æ¨¡å‹æ˜ å°„

| åŠŸèƒ½ | Redis | BoltDB |
|-----|-------|--------|
| ç­‰å¾…é˜Ÿåˆ— | `HSET waitseqcache` | Bucket: `wait` |
| æ¶ˆæ¯åˆ—è¡¨ | `LPUSH list_message` | Bucket: `messages` |
| MOåˆ—è¡¨ | `LPUSH list_mo` | Bucket: `mo` |

**BoltDB ç‰¹æ€§**ï¼š
- ä½¿ç”¨ Bucket ç»„ç»‡æ•°æ®
- Key ä½¿ç”¨å€’åºæ—¶é—´æˆ³ + åºåˆ—å·
- è‡ªåŠ¨æŒä¹…åŒ–åˆ°ç£ç›˜
- æ”¯æŒäº‹åŠ¡

### 4. é…ç½®æ–‡ä»¶

#### BoltDB é…ç½®ï¼ˆé»˜è®¤ï¼‰
```json
{
  "cache_type": "boltdb",
  "db_path": "./data/cmpp.db"
}
```

#### Redis é…ç½®ï¼ˆå¯é€‰ï¼‰
```json
{
  "cache_type": "redis",
  "redis_host": "127.0.0.1",
  "redis_port": "6379",
  "redis_password": ""
}
```

### 5. æ–‡æ¡£

åˆ›å»ºå®Œæ•´çš„æ–‡æ¡£ä½“ç³»ï¼š

- âœ… `BOLTDB_MIGRATION.md` - è¯¦ç»†è¿ç§»æŒ‡å—ï¼ˆ7.7Kï¼‰
  - æ–¹æ¡ˆè¯´æ˜
  - ä½¿ç”¨æ–¹æ³•
  - æ€§èƒ½å¯¹æ¯”
  - æ•…éšœæ’æŸ¥
  - æœ€ä½³å®è·µ

- âœ… `QUICK_START_BOLTDB.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
  - 5åˆ†é’Ÿä¸Šæ‰‹
  - å¸¸è§é—®é¢˜
  - éªŒè¯æ¸…å•

- âœ… `config.boltdb.json` - BoltDB é…ç½®ç¤ºä¾‹

- âœ… æ›´æ–° `README.md`
  - åŠŸèƒ½ç‰¹æ€§æ›´æ–°
  - ç³»ç»Ÿæ¶æ„å›¾æ›´æ–°
  - å¿«é€Ÿå¼€å§‹æ›´æ–°
  - é…ç½®è¯´æ˜æ›´æ–°

---

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### 1. çº¯ Go å®ç°

- âœ… æ— éœ€ CGO
- âœ… è·¨å¹³å°ç¼–è¯‘æ— éšœç¢
- âœ… å•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶éƒ¨ç½²

### 2. é›¶å¤–éƒ¨ä¾èµ–

- âœ… æ— éœ€å®‰è£… Redis
- âœ… æ— éœ€é…ç½®å¤–éƒ¨æœåŠ¡
- âœ… å¼€ç®±å³ç”¨

### 3. æ¥å£æŠ½è±¡

- âœ… ç»Ÿä¸€çš„æ¥å£å®šä¹‰
- âœ… ä¸¤ç§å®ç°å¯åˆ‡æ¢
- âœ… å‘åå®Œå…¨å…¼å®¹

### 4. æ•°æ®å®‰å…¨

- âœ… äº‹åŠ¡ä¿è¯åŸå­æ€§
- âœ… è‡ªåŠ¨æŒä¹…åŒ–
- âœ… å´©æºƒæ¢å¤

### 5. å€’åºå­˜å‚¨

```go
// ä½¿ç”¨åè½¬æ—¶é—´æˆ³å®ç°å€’åº
invertedTime := uint64(1<<63 - 1 - now)
```

ç¡®ä¿æœ€æ–°æ¶ˆæ¯æ’åœ¨å‰é¢ï¼Œç¬¦åˆ Redis `LPUSH` çš„è¡Œä¸ºã€‚

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | BoltDB | Redis |
|-----|--------|-------|
| è¯»æ€§èƒ½ | âš¡ï¸ æå¿«ï¼ˆmmapï¼‰ | âš¡ï¸ æå¿«ï¼ˆçº¯å†…å­˜ï¼‰ |
| å†™æ€§èƒ½ | ğŸŸ¢ å¿«ï¼ˆäº‹åŠ¡ï¼‰ | âš¡ï¸ æå¿«ï¼ˆå¼‚æ­¥ï¼‰ |
| å†…å­˜å ç”¨ | ğŸŸ¢ ä½ï¼ˆæŒ‰éœ€ï¼‰ | ğŸŸ¡ é«˜ï¼ˆå…¨å†…å­˜ï¼‰ |
| ç£ç›˜å ç”¨ | ğŸŸ¢ é€‚ä¸­ | ğŸŸ¢ é€‚ä¸­ï¼ˆAOFï¼‰ |
| å¹¶å‘è¯» | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| å¹¶å‘å†™ | ğŸŸ¡ å•å†™ | âœ… é«˜å¹¶å‘ |
| å¯åŠ¨é€Ÿåº¦ | âš¡ï¸ ç¬é—´ | ğŸŸ¢ å¿« |
| éƒ¨ç½²å¤æ‚åº¦ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ |

**ç»“è®º**ï¼šå¯¹äº CMPP ç½‘å…³ï¼ˆä¸­å°è§„æ¨¡ï¼‰åœºæ™¯ï¼ŒBoltDB å®Œå…¨æ»¡è¶³éœ€æ±‚ã€‚

---

## ğŸ”„ è¿ç§»è·¯å¾„

### æ–°éƒ¨ç½²ï¼ˆæ¨èï¼‰

ç›´æ¥ä½¿ç”¨ BoltDBï¼š
```bash
# 1. é…ç½® cache_type: "boltdb"
# 2. å¯åŠ¨ç¨‹åº
./cmpp-gateway
```

### ç°æœ‰éƒ¨ç½²

ä¸¤ç§é€‰æ‹©ï¼š

**é€‰é¡¹ 1ï¼šç»§ç»­ä½¿ç”¨ Redis**
- é…ç½® `cache_type: "redis"`
- æ— éœ€ä»»ä½•æ”¹åŠ¨

**é€‰é¡¹ 2ï¼šè¿ç§»åˆ° BoltDB**
- ä¿®æ”¹é…ç½®æ–‡ä»¶
- é‡å¯ç¨‹åº
- å†å²æ•°æ®è‡ªåŠ¨ä»é›¶å¼€å§‹ï¼ˆæ¶ˆæ¯æ•°æ®æ˜¯çŸ­æš‚çš„ï¼‰

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### ç¼–è¯‘æµ‹è¯•

```bash
âœ… go mod tidy          # ä¾èµ–ä¸‹è½½æˆåŠŸ
âœ… go mod vendor        # vendor åŒæ­¥æˆåŠŸ
âœ… go build -mod=mod    # ç¼–è¯‘æˆåŠŸï¼ˆ12MBï¼‰
```

### åŠŸèƒ½éªŒè¯

éœ€è¦éªŒè¯çš„åŠŸèƒ½ç‚¹ï¼š

- [ ] BoltDB åˆå§‹åŒ–
- [ ] ç­‰å¾…é˜Ÿåˆ—ï¼ˆwait bucketï¼‰
  - [ ] SetWaitCache
  - [ ] GetWaitCacheï¼ˆè¯»ååˆ é™¤ï¼‰
- [ ] æ¶ˆæ¯åˆ—è¡¨ï¼ˆmessages bucketï¼‰
  - [ ] AddSubmits
  - [ ] GetListï¼ˆå€’åºï¼‰
  - [ ] Length
  - [ ] GetStats
- [ ] MOåˆ—è¡¨ï¼ˆmo bucketï¼‰
  - [ ] AddMoList
  - [ ] GetListï¼ˆå€’åºï¼‰
- [ ] æ•°æ®æŒä¹…åŒ–
  - [ ] é‡å¯åæ•°æ®æ¢å¤
- [ ] Web ç•Œé¢
  - [ ] ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
  - [ ] æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤º
- [ ] API æ¥å£
  - [ ] å‘é€æ¶ˆæ¯
  - [ ] æŸ¥è¯¢åˆ—è¡¨

---

## ğŸ“¦ äº¤ä»˜ç‰©

### ä»£ç æ–‡ä»¶

```
gateway/
â”œâ”€â”€ boltcache.go       # BoltDB å®ç°ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ cache.go           # æ¥å£å®šä¹‰å’Œ Redis å®ç°ï¼ˆä¿®æ”¹ï¼‰
â”œâ”€â”€ config.go          # é…ç½®ç»“æ„ï¼ˆä¿®æ”¹ï¼‰
â””â”€â”€ ...

main.go                # å¯åŠ¨é€»è¾‘ï¼ˆä¿®æ”¹ï¼‰
go.mod                 # ä¾èµ–ç®¡ç†ï¼ˆæ›´æ–°ï¼‰
```

### é…ç½®æ–‡ä»¶

```
config.boltdb.json     # BoltDB é…ç½®ç¤ºä¾‹ï¼ˆæ–°å¢ï¼‰
config.json            # Redis é…ç½®ï¼ˆä¿ç•™ï¼‰
```

### æ–‡æ¡£

```
BOLTDB_MIGRATION.md       # å®Œæ•´è¿ç§»æŒ‡å—ï¼ˆæ–°å¢ï¼‰
QUICK_START_BOLTDB.md     # å¿«é€Ÿå¼€å§‹ï¼ˆæ–°å¢ï¼‰
REFACTORING_SUMMARY.md    # æœ¬æ–‡æ¡£ï¼ˆæ–°å¢ï¼‰
README.md                 # ä¸»æ–‡æ¡£ï¼ˆæ›´æ–°ï¼‰
```

### ç¼–è¯‘äº§ç‰©

```
cmpp-gateway           # å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆ12MBï¼‰
data/
â””â”€â”€ cmpp.db           # BoltDB æ•°æ®æ–‡ä»¶ï¼ˆè¿è¡Œæ—¶åˆ›å»ºï¼‰
```

---

## ğŸ“ æŠ€æœ¯å€ºåŠ¡

### å·²è§£å†³

- âœ… Redis å¤–éƒ¨ä¾èµ–
- âœ… éƒ¨ç½²å¤æ‚åº¦
- âœ… è·¨å¹³å°ç¼–è¯‘é—®é¢˜ï¼ˆCGOï¼‰

### å¾…æ”¹è¿›

- â³ è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®ï¼ˆé¿å…æ•°æ®åº“æ— é™å¢é•¿ï¼‰
- â³ æ•°æ®åº“å®šæœŸå‹ç¼©
- â³ æ•°æ®å¯¼å…¥å¯¼å‡ºå·¥å…·
- â³ æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸ

1. **åŠŸèƒ½æµ‹è¯•**
   - ä½¿ç”¨æ¨¡æ‹Ÿå™¨è¿›è¡Œå®Œæ•´åŠŸèƒ½æµ‹è¯•
   - å‹åŠ›æµ‹è¯•ï¼ˆå¤§é‡æ¶ˆæ¯ï¼‰
   - é•¿æ—¶é—´è¿è¡Œæµ‹è¯•

2. **æ–‡æ¡£å®Œå–„**
   - è¡¥å……æ€§èƒ½æµ‹è¯•æ•°æ®
   - æ·»åŠ æ•…éšœæ’æŸ¥æ¡ˆä¾‹

### ä¸­æœŸ

1. **åŠŸèƒ½å¢å¼º**
   - å®ç°è‡ªåŠ¨æ•°æ®æ¸…ç†
   - æ·»åŠ æ•°æ®åº“ç›‘æ§æŒ‡æ ‡
   - å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰¹é‡å†™å…¥ä¼˜åŒ–
   - ç¼“å­˜é¢„çƒ­
   - ç´¢å¼•ä¼˜åŒ–

### é•¿æœŸ

1. **é«˜çº§ç‰¹æ€§**
   - æ”¯æŒæ•°æ®è¿ç§»å·¥å…·
   - æ”¯æŒä¸»ä»åŒæ­¥ï¼ˆå¦‚éœ€è¦ï¼‰
   - æ”¯æŒæ•°æ®åŠ å¯†

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### éƒ¨ç½²ä¾¿åˆ©æ€§

- â¬‡ï¸ éƒ¨ç½²æ­¥éª¤ï¼šä» 2 æ­¥å‡å°‘åˆ° 1 æ­¥
- â¬‡ï¸ å¤–éƒ¨ä¾èµ–ï¼šä» 1 ä¸ªå‡å°‘åˆ° 0 ä¸ª
- â¬†ï¸ éƒ¨ç½²æˆåŠŸç‡ï¼šæå‡åˆ°æ¥è¿‘ 100%

### è¿ç»´æˆæœ¬

- â¬‡ï¸ å­¦ä¹ æˆæœ¬ï¼šæ— éœ€å­¦ä¹  Redis
- â¬‡ï¸ ç»´æŠ¤æˆæœ¬ï¼šæ— éœ€ç»´æŠ¤ Redis æœåŠ¡
- â¬‡ï¸ æ•…éšœç‚¹ï¼šå‡å°‘ä¸€ä¸ªå¤–éƒ¨æœåŠ¡ä¾èµ–

### å¼€å‘ä½“éªŒ

- â¬†ï¸ å¼€å‘æ•ˆç‡ï¼šæ— éœ€æœ¬åœ°å®‰è£… Redis
- â¬†ï¸ è°ƒè¯•ä¾¿åˆ©ï¼šæ•°æ®æ–‡ä»¶å¯ç›´æ¥æŸ¥çœ‹
- â¬†ï¸ æµ‹è¯•æ•ˆç‡ï¼šæ— éœ€ Mock Redis

---

## âœ¨ æ€»ç»“

è¿™æ¬¡é‡æ„æˆåŠŸå®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š

1. âœ… **æ¶ˆé™¤å¤–éƒ¨ä¾èµ–**ï¼šä¸å†éœ€è¦ Redis
2. âœ… **ç®€åŒ–éƒ¨ç½²**ï¼šå•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å³å¯è¿è¡Œ
3. âœ… **ä¿æŒå…¼å®¹**ï¼šä»æ”¯æŒ Redisï¼ˆå¯é€‰ï¼‰
4. âœ… **çº¯ Go å®ç°**ï¼šè·¨å¹³å°ç¼–è¯‘æ— éšœç¢
5. âœ… **æ¥å£æŠ½è±¡**ï¼šä¾¿äºæœªæ¥æ‰©å±•å…¶ä»–å®ç°

**æ¨èä½¿ç”¨åœºæ™¯**ï¼š
- âœ… æ–°é¡¹ç›®
- âœ… ä¸­å°è§„æ¨¡éƒ¨ç½²
- âœ… å•æœºéƒ¨ç½²
- âœ… ç®€åŒ–è¿ç»´éœ€æ±‚

**ç»§ç»­ä½¿ç”¨ Redis çš„åœºæ™¯**ï¼š
- éœ€è¦åˆ†å¸ƒå¼éƒ¨ç½²
- è¶…å¤§è§„æ¨¡æ¶ˆæ¯å¤„ç†
- å·²æœ‰ Redis åŸºç¡€è®¾æ–½
- éœ€è¦ Redis çš„å…¶ä»–ç‰¹æ€§

---

**é‡æ„æˆåŠŸï¼** ğŸ‰

ä»£ç è´¨é‡ï¼šâ­ï¸â­ï¸â­ï¸â­ï¸â­ï¸  
æ–‡æ¡£å®Œæ•´åº¦ï¼šâ­ï¸â­ï¸â­ï¸â­ï¸â­ï¸  
å‘åå…¼å®¹æ€§ï¼šâ­ï¸â­ï¸â­ï¸â­ï¸â­ï¸  

